\chapter{SQL Queries}
\label{ch:sql-queries}

This chapter lists the core parameterized queries used by \projectname{} (via Prisma RAW Query). Each entry includes a brief description and a minimal SQL snippet. Performance charts, parameters, and optimization notes are intentionally omitted per requirements.

% 1
\section{List Papers (paginated)}
Retrieves active papers in a workspace, ordered by recency.
\begin{lstlisting}[language=SQL]
SELECT p.id, p.title, p."publicationYear", p."createdAt"
FROM "Paper" p
WHERE p."workspaceId" = $1 AND p."isDeleted" = false
ORDER BY p."createdAt" DESC
LIMIT $2 OFFSET $3;
\end{lstlisting}

% 2
\section{Paper Details with Uploader}
Gets a single paper with uploader info and lightweight counts.
\begin{lstlisting}[language=SQL]
SELECT p.*, u.name AS "uploaderName",
       COUNT(DISTINCT cp."collectionId")::int AS "collectionCount"
FROM "Paper" p
JOIN "User" u ON p."uploaderId" = u.id
LEFT JOIN "CollectionPaper" cp ON cp."paperId" = p.id AND cp."isDeleted" = false
WHERE p.id = $1 AND p."isDeleted" = false
GROUP BY p.id, u.name;
\end{lstlisting}

% 3
\section{Search Papers (full-text)}
Full-text search across title and authors using GIN index.
\begin{lstlisting}[language=SQL]
SELECT id, title, authors
FROM "Paper"
WHERE "workspaceId" = $1 AND "isDeleted" = false
  AND to_tsvector('english', title || ' ' || coalesce(authors,'')) @@ plainto_tsquery($2)
ORDER BY "createdAt" DESC
LIMIT $3 OFFSET $4;
\end{lstlisting}

% 4
\section{Recent Papers by User}
Lists the last N papers uploaded by a user.
\begin{lstlisting}[language=SQL]
SELECT id, title, "createdAt"
FROM "Paper"
WHERE "uploaderId" = $1 AND "isDeleted" = false
ORDER BY "createdAt" DESC
LIMIT $2;
\end{lstlisting}

% 5
\section{Papers in a Collection}
Retrieves papers that belong to a collection.
\begin{lstlisting}[language=SQL]
SELECT p.id, p.title
FROM "CollectionPaper" cp
JOIN "Paper" p ON p.id = cp."paperId"
WHERE cp."collectionId" = $1 AND cp."isDeleted" = false AND p."isDeleted" = false
ORDER BY cp."addedAt" DESC
LIMIT $2 OFFSET $3;
\end{lstlisting}

% 6
\section{User Collections with Counts}
Collections created by a user with paper/member aggregates.
\begin{lstlisting}[language=SQL]
SELECT c.id, c.name,
       COUNT(DISTINCT cp."paperId")::int AS "paperCount",
       COUNT(DISTINCT cm.id)::int AS "memberCount"
FROM "Collection" c
LEFT JOIN "CollectionPaper" cp ON c.id = cp."collectionId" AND cp."isDeleted" = false
LEFT JOIN "CollectionMember" cm ON c.id = cm."collectionId" AND cm."isDeleted" = false
WHERE c."creatorId" = $1 AND c."isDeleted" = false
GROUP BY c.id
ORDER BY c."createdAt" DESC;
\end{lstlisting}

% 7
\section{Batch Add Papers to Collection}
Adds many papers in one round-trip, skipping duplicates.
\begin{lstlisting}[language=SQL]
INSERT INTO "CollectionPaper"("collectionId","paperId","addedById","addedAt")
SELECT $1, unnest($2::int[]), $3, NOW()
ON CONFLICT ("collectionId","paperId") DO NOTHING;
\end{lstlisting}

% 8
\section{Remove Paper from Collection}
Soft-removes a paper from a collection.
\begin{lstlisting}[language=SQL]
UPDATE "CollectionPaper"
SET "isDeleted" = true, "deletedAt" = NOW()
WHERE "collectionId" = $1 AND "paperId" = $2;
\end{lstlisting}

% 9
\section{Workspace Members}
Lists active members with basic profile info.
\begin{lstlisting}[language=SQL]
SELECT wm.id, wm.role, wm."joinedAt",
       u.id AS "userId", u.name, u.email
FROM "WorkspaceMember" wm
JOIN "User" u ON wm."userId" = u.id
WHERE wm."workspaceId" = $1 AND wm.status = 'ACTIVE'
ORDER BY wm."joinedAt" ASC;
\end{lstlisting}

% 10
\section{Update Member Role (authorized)}
Updates a member's role if the requester has sufficient role.
\begin{lstlisting}[language=SQL]
UPDATE "WorkspaceMember" wm
SET role = $3
FROM "WorkspaceMember" req
WHERE wm."workspaceId" = $1 AND wm."userId" = $2
  AND req."workspaceId" = $1 AND req."userId" = $4
  AND req.role IN ('OWNER','TEAM_LEAD')
RETURNING wm.id, wm.role;
\end{lstlisting}

% 11
\section{Top Tags in Workspace}
Returns the most used tags for discovery.
\begin{lstlisting}[language=SQL]
SELECT t.name, COUNT(pt."paperId")::int AS uses
FROM "Tag" t
JOIN "PaperTag" pt ON pt."tagId" = t.id
JOIN "Paper" p ON p.id = pt."paperId"
WHERE p."workspaceId" = $1 AND p."isDeleted" = false
GROUP BY t.name
ORDER BY uses DESC
LIMIT 20;
\end{lstlisting}

% 12
\section{Orphan Papers (no collection)}
Papers not assigned to any collection (for cleanup views).
\begin{lstlisting}[language=SQL]
SELECT p.id, p.title
FROM "Paper" p
LEFT JOIN "CollectionPaper" cp ON cp."paperId" = p.id AND cp."isDeleted" = false
WHERE p."workspaceId" = $1 AND p."isDeleted" = false
  AND cp."paperId" IS NULL
ORDER BY p."createdAt" DESC;
\end{lstlisting}

% 13
\section{Papers per Year (histogram)}
Counts papers by publication year for charts.
\begin{lstlisting}[language=SQL]
SELECT "publicationYear" AS year, COUNT(*)::int AS count
FROM "Paper"
WHERE "workspaceId" = $1 AND "isDeleted" = false AND "publicationYear" IS NOT NULL
GROUP BY year
ORDER BY year DESC;
\end{lstlisting}
